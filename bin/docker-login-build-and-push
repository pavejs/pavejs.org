#!/bin/sh -e

# Login to docker
echo "$DOCKER_PASSWORD" | \
  docker login -u $DOCKER_USERNAME --password-stdin 

# Intialize vars
REF=${GITHUB_REF#refs/*/}
REF=${REF:-$GITHUB_SHA}

# Pulls initial version from docker, which is used as a cache to expedite build process
docker pull $IMAGE_REPO:$GITHUB_SHA ||
  docker pull $IMAGE_REPO:$REF ||
  docker pull $IMAGE_REPO:main ||
  true

# Build docker image
docker build \
  --cache-from $IMAGE_REPO:$GITHUB_SHA \
  --cache-from $IMAGE_REPO:$REF \
  --cache-from $IMAGE_REPO:main \
  --tag $IMAGE_REPO:$GITHUB_SHA \
  --tag $IMAGE_REPO:$REF \
  "$@"

# Push docker image to repo
docker push $IMAGE_REPO:$GITHUB_SHA

docker push $IMAGE_REPO:$REF 